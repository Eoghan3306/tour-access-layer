<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ross Castle & Copper Mines Audio Tour</title> 
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* --- DESIGN SYSTEM (Standardized) --- */
  :root {
    --primary: #8fa87a;
    --primary-light: #b7cba9;
    --dark: #2c3e50;
    --light: #ffffff;
    --gray: #f5f7fa;
    --shadow: 0 8px 30px rgba(0,0,0,0.12);
    --radius: 12px;
    --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --highlight-color: #ff3333; 
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body { 
    margin: 0; padding: 0; 
    font-family: 'Inter', sans-serif; 
    display: flex; height: 100vh; height: 100dvh; 
    overflow: hidden; color: var(--dark); background: var(--gray); 
  }

  /* --- Map & Layout --- */
  #map-container { flex: 1; position: relative; display: flex; flex-direction: column; height: 100%; width: 100%; }
  #map { width: 100%; height: 100%; flex: 1; outline: none; }

  /* --- Sidebar --- */
  #sidebar { 
    position: absolute; top: 20px; left: 20px; width: 280px; max-height: calc(100vh - 180px); 
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-radius: var(--radius); padding: 0; box-shadow: var(--shadow); z-index: 100; 
    display: flex; flex-direction: column; transform: translateX(0); transition: transform var(--transition); 
    overflow: hidden; border: 1px solid rgba(255,255,255,0.4); 
  }
  #sidebar.closed { transform: translateX(-150%); }

  .sidebar-header { padding: 16px 20px; background: var(--primary-light); color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .sidebar-title-group h2 { font-size: 16px; margin: 0; font-weight: 700; color: var(--dark); }
  .sidebar-subtitle { font-size: 11px; opacity: 0.8; color: var(--dark); margin-top: 2px; text-transform: uppercase; font-weight: 600; }
  
  #closeSidebarInner { background: rgba(255,255,255,0.3); border: none; color: var(--dark); width: 32px; height: 32px; border-radius: 50%; font-size: 20px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
  #closeSidebarInner:hover { background: rgba(255,255,255,0.6); }

  #stops { list-style: none; padding: 0; margin: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  #stops li { padding: 16px 20px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 14px; font-weight: 500; transition: background 0.2s; display: flex; align-items: center; }
  #stops li:hover { background: #f0f4ec; color: var(--primary); }
  #stops li::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--primary-light); border-radius: 50%; margin-right: 12px; flex-shrink: 0; }

  /* --- Player --- */
  #persistent-player { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 420px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.15); z-index: 50; padding: 12px; border: 1px solid rgba(255,255,255,0.6); transition: bottom 0.3s ease; }
  #soundcloud-player { width: 100%; height: 120px; border: none; border-radius: 8px; display: block; background: #f5f5f5; }
  .player-attribution { font-size: 11px; color: #888; text-align: center; margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .player-attribution a { color: var(--primary); text-decoration: none; font-weight: 600; }
  .mobile-handle { display: none; }

  /* --- Controls & Buttons --- */
  .control-pill { position: absolute; top: 20px; z-index: 40; background: var(--dark); color: white; border: none; border-radius: 30px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; transition: transform 0.1s, background 0.2s; }
  .control-pill:active { transform: scale(0.98); }
  #toggleSidebar { left: 20px; padding: 10px 16px; gap: 8px; }
  body:not(.sidebar-closed) #toggleSidebar { display: none; }

  .select-wrapper { position: absolute; top: 20px; right: 20px; z-index: 40; }
  #styleDropdown { appearance: none; -webkit-appearance: none; background-color: var(--dark); color: white; border: none; border-radius: 30px; padding: 10px 36px 10px 20px; font-size: 13px; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto; }
  .mapboxgl-ctrl-top-right { top: 65px !important; right: 20px !important; }

  /* --- Pulse Animation --- */
  @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.9); } 70% { box-shadow: 0 0 0 25px rgba(255, 51, 51, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); } }
  .highlight-active { animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; position: relative; z-index: 9999 !important; transition: all 0.3s; transform: scale(1.05); border: 2px solid var(--highlight-color) !important; }
  .mapboxgl-ctrl-geolocate.highlight-active { border-radius: 50% !important; }
  #toggleSidebar.highlight-active { position: absolute; }

  /* --- Markers --- */
  .marker { background-size: cover; background-color: var(--primary-light); border: 2px solid white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s, background 0.2s; display: flex; align-items: center; justify-content: center; font-weight: 700; }
  .marker:hover { transform: scale(1.15); z-index: 50; border-color: var(--dark); }
  .marker-node { width: 28px; height: 28px; border-radius: 50%; color: white; font-size: 12px; }
  .marker-start { width: 50px; height: 50px; background-color: var(--dark); color: white; border-radius: 50%; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border: 3px solid white; }
  .marker-end { width: 40px; height: 40px; background-color: #e74c3c; color: white; border-radius: 50%; font-size: 10px; font-weight: 700; border: 3px solid white; }

  /* --- Modals & Tour Overlay --- */
  .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); align-items: center; justify-content: center; opacity: 0; animation: fadeIn 0.3s forwards; }
  .modal-content { background: white; padding: 24px 32px; border-radius: 16px; max-width: 320px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); transform: scale(0.9); animation: popIn 0.3s forwards; }
  .modal-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
  .btn { padding: 10px 24px; border: none; border-radius: 30px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: var(--dark); color: white; }
  .btn-secondary { background: #e0e0e0; color: #333; }

  #tourOverlay { position: fixed; bottom: 220px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.95); color: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 340px; text-align: center; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; backdrop-filter: blur(8px); animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  #tourMessage { font-size: 14px; line-height: 1.5; margin-bottom: 15px; }
  .tour-actions { display: flex; justify-content: space-between; align-items: center; }
  .btn-tour { padding: 6px 14px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
  #tourNext { background: var(--primary-light); color: var(--dark); }
  #tourSkip { background: transparent; color: #aaa; }

  @keyframes fadeIn { to { opacity: 1; } }
  @keyframes popIn { to { transform: scale(1); } }
  @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

  /* --- Responsive --- */
  @media (max-width: 768px) {
    .mapboxgl-ctrl-top-right { top: 70px !important; }
    #toggleSidebar { display: flex !important; top: 15px; left: 15px; }
    .select-wrapper { top: 15px; right: 15px; }
    #sidebar { top: 0; left: 0; height: 100dvh; max-height: 100dvh; width: 100%; border-radius: 0; border: none; transform: translateX(-100%); z-index: 2000; }
    #sidebar.active { transform: translateX(0); }
    #sidebar.closed { transform: translateX(-100%); }
    #persistent-player { bottom: 0; left: 0; width: 100%; max-width: 100%; transform: none; border-radius: 24px 24px 0 0; padding: 12px 12px 0 12px; padding-bottom: calc(env(safe-area-inset-bottom) + 15px); background: white; }
    #soundcloud-player { height: 110px; }
    .mobile-handle { display: block; width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 10px auto; }
    #tourOverlay { bottom: 180px; }
  }
</style>
</head>
<body>

<button id="toggleSidebar" class="control-pill">
  <span>â˜°</span> Route List
</button>

<div id="sidebar" class="closed"> 
  <div class="sidebar-header">
    <div class="sidebar-title-group">
      <h2>Ross Castle & Copper Mines</h2>
      <div class="sidebar-subtitle">Audio Guided Tour</div>
    </div>
    <button id="closeSidebarInner" aria-label="Close Menu">&times;</button>
  </div>
  <ul id="stops"></ul>
</div>

<div id="map-container">
  <div class="select-wrapper">
    <select id="styleDropdown">
      <option value="mapbox://styles/mapbox/outdoors-v12" selected>Outdoors</option>
      <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
      <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite</option>
      <option value="mapbox://styles/mapbox/light-v11">Light</option>
      <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
    </select>
  </div>
  
  <div id="map"></div>

  <div id="persistent-player">
    <div class="mobile-handle"></div>
    <iframe id="soundcloud-player" scrolling="no" frameborder="no" allow="autoplay" src=""></iframe>
    <div class="player-attribution">
      <a href="https://soundcloud.com/killarneyaudiotours/ross-castle-copper-mines/s-6OoZdL8CX0T" target="_blank">Ross Castle Audio</a>
    </div>
  </div>
</div>

<div id="audioModal" class="modal">
  <div class="modal-content">
    <p id="modal-text">Jump audio to this location?</p>
    <div class="modal-buttons">
      <button id="modal-yes" class="btn btn-primary">Yes, Play</button>
      <button id="modal-no" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<div id="tourOverlay">
  <div id="tourMessage"></div>
  <div class="tour-actions">
    <button id="tourSkip" class="btn-tour">Dismiss</button>
    <button id="tourNext" class="btn-tour">Next Step</button>
  </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://w.soundcloud.com/player/api.js"></script>

<script>
// ============================================================================
// SECTION B: TOUR CONFIGURATION
// ============================================================================

// 1. Map Start Position
const START_CENTER = [-9.52200, 52.03870]; 
const START_ZOOM = 14;

// 2. SoundCloud Source URL (UPDATED TRACK)
const SC_SRC = "https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/soundcloud%3Atracks%3A2260498922%3Fsecret_token%3Ds-6OoZdL8CX0T&color=%23b7cba9&auto_play=false&hide_related=false&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=false";

// 3. Audio Timestamps
const audioTimestamps = [0, 196000, 300000, 481000, 624000, 751000, 940000, 1037000, 1219000];

// 4. Mapbox Token
mapboxgl.accessToken = 'pk.eyJ1IjoiZW9naGFub2QiLCJhIjoiY21lOXFwOGhyMHVvNTJrcXZnY3I1dGlnOSJ9.7g8Xb_w6p8QiMNloqwPVRQ';

// 5. Route Line Data
const routeGeoJSON = { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[-9.53021,52.04176],[-9.53049,52.0417],[-9.53074,52.04166],[-9.53158,52.04151],[-9.53193,52.04144],[-9.53194,52.04135],[-9.53195,52.04121],[-9.53193,52.04114],[-9.53192,52.04112],[-9.53189,52.04109],[-9.53186,52.04106],[-9.53182,52.04104],[-9.53175,52.04102],[-9.53163,52.041],[-9.53116,52.04096],[-9.53112,52.04097],[-9.53108,52.04099],[-9.53105,52.04102],[-9.53101,52.04104],[-9.53085,52.04108],[-9.53071,52.04112],[-9.5307,52.04107],[-9.53065,52.04086],[-9.53047,52.04016],[-9.53046,52.04011],[-9.53044,52.04001],[-9.53043,52.03994],[-9.53043,52.03993],[-9.53043,52.03985],[-9.53045,52.03976],[-9.53045,52.03975],[-9.53047,52.03972],[-9.53054,52.03965],[-9.5306,52.0396],[-9.53064,52.03956],[-9.5308,52.03946],[-9.53083,52.03945],[-9.53092,52.03939],[-9.53099,52.03933],[-9.531,52.03932],[-9.53107,52.03921],[-9.53107,52.03916],[-9.53108,52.03911],[-9.53107,52.039],[-9.53107,52.03898],[-9.53107,52.03893],[-9.5311,52.0388],[-9.5311,52.03876],[-9.53115,52.03863],[-9.53116,52.03861],[-9.53121,52.03852],[-9.53123,52.03845],[-9.53124,52.03839],[-9.53122,52.03828],[-9.53122,52.03827],[-9.53123,52.03817],[-9.53126,52.0381],[-9.53128,52.03804],[-9.53132,52.03792],[-9.53134,52.03789],[-9.53142,52.03775],[-9.53147,52.03768],[-9.5315,52.03764],[-9.53154,52.03759],[-9.53155,52.03756],[-9.53168,52.03749],[-9.53175,52.03747],[-9.53191,52.03744],[-9.53202,52.03741],[-9.5321,52.03739],[-9.53225,52.03733],[-9.53244,52.03724],[-9.53251,52.03721],[-9.53253,52.0372],[-9.5326,52.03718],[-9.53273,52.03716],[-9.53279,52.03716],[-9.53293,52.03716],[-9.53308,52.03717],[-9.53313,52.03717],[-9.53337,52.03715],[-9.53356,52.03713],[-9.53368,52.03711],[-9.53389,52.03707],[-9.53405,52.03702],[-9.5342,52.03699],[-9.53423,52.03699],[-9.53441,52.03697],[-9.53454,52.03696],[-9.53478,52.03697],[-9.53483,52.03697],[-9.53512,52.03703],[-9.53543,52.03715],[-9.5357,52.03728],[-9.53606,52.03739],[-9.53611,52.0374],[-9.53649,52.03745],[-9.53669,52.03744],[-9.53687,52.03744],[-9.53698,52.03743],[-9.53725,52.03741],[-9.53739,52.03741],[-9.53755,52.03737],[-9.53757,52.03737],[-9.53772,52.03732],[-9.5378,52.03728],[-9.53793,52.0372],[-9.53805,52.03714],[-9.53816,52.0371],[-9.53828,52.0371],[-9.53846,52.03712],[-9.53858,52.03713],[-9.53875,52.03713],[-9.53886,52.03713],[-9.53891,52.03712],[-9.53901,52.03711],[-9.53915,52.03712],[-9.53927,52.03717],[-9.53933,52.03725],[-9.53934,52.03733],[-9.53933,52.03742],[-9.53935,52.0375],[-9.53939,52.03761],[-9.53986,52.03747],[-9.54039,52.03732],[-9.5405,52.03729],[-9.54065,52.03725],[-9.54085,52.03719],[-9.54104,52.03717],[-9.54115,52.03718],[-9.54124,52.03719],[-9.54137,52.03721],[-9.54138,52.03721],[-9.54141,52.03721],[-9.54146,52.03721],[-9.5415,52.0372],[-9.5417,52.03732],[-9.54194,52.03746],[-9.54207,52.03756],[-9.54207,52.03757],[-9.54208,52.03759],[-9.54206,52.03762],[-9.54201,52.03771],[-9.54197,52.03787],[-9.54201,52.03771],[-9.54206,52.03762],[-9.54208,52.03759],[-9.54207,52.03757],[-9.54207,52.03756],[-9.54194,52.03746],[-9.5417,52.03732],[-9.5415,52.0372],[-9.5416,52.03716],[-9.54169,52.03709],[-9.54172,52.03701],[-9.54173,52.03693],[-9.54169,52.03685],[-9.54162,52.03679],[-9.54145,52.03672],[-9.54114,52.03667],[-9.54099,52.03664],[-9.54075,52.0366],[-9.54071,52.03659],[-9.54043,52.03653],[-9.54023,52.03649],[-9.54016,52.03647],[-9.53982,52.03635],[-9.53953,52.0362],[-9.53936,52.03611],[-9.53918,52.03609],[-9.539,52.03608],[-9.53889,52.03606],[-9.53879,52.03605],[-9.53865,52.036],[-9.53851,52.0359],[-9.53847,52.03584],[-9.53841,52.03574],[-9.53829,52.03562],[-9.53818,52.0355],[-9.53836,52.03541],[-9.53856,52.03532],[-9.53872,52.03523],[-9.53876,52.03512],[-9.53875,52.03505],[-9.53871,52.03499],[-9.53867,52.03496],[-9.53864,52.03494],[-9.53856,52.0349],[-9.53845,52.03487],[-9.53842,52.03487],[-9.53829,52.03487],[-9.53814,52.03488],[-9.53813,52.03488],[-9.53802,52.03492],[-9.53782,52.03501],[-9.53765,52.03509],[-9.53757,52.03513],[-9.5375,52.03516],[-9.53743,52.03518],[-9.53724,52.03522],[-9.53713,52.03523],[-9.53702,52.03523],[-9.53688,52.03524],[-9.53684,52.03525],[-9.5368,52.03526],[-9.53674,52.03532],[-9.53669,52.03539],[-9.53669,52.0354],[-9.53666,52.0355],[-9.53663,52.03568],[-9.53655,52.03582],[-9.53638,52.03594],[-9.53619,52.03609],[-9.53618,52.0361],[-9.53606,52.03622],[-9.53603,52.03626],[-9.536,52.03629],[-9.53598,52.03637],[-9.53597,52.03643],[-9.53597,52.03645],[-9.53596,52.03651],[-9.53591,52.03655],[-9.53585,52.03659],[-9.53584,52.03659],[-9.53573,52.03664],[-9.53562,52.03669],[-9.53557,52.03671],[-9.53536,52.03678],[-9.5353,52.0368],[-9.53478,52.03697],[-9.53454,52.03696],[-9.53441,52.03697],[-9.53423,52.03699],[-9.5342,52.03699],[-9.53405,52.03702],[-9.53389,52.03707],[-9.53368,52.03711],[-9.53356,52.03713],[-9.53337,52.03715],[-9.53313,52.03717],[-9.53308,52.03717],[-9.53293,52.03716],[-9.53279,52.03716],[-9.53273,52.03716],[-9.5326,52.03718],[-9.53253,52.0372],[-9.53251,52.03721],[-9.53244,52.03724],[-9.53225,52.03733],[-9.5321,52.03739],[-9.53202,52.03741],[-9.53191,52.03744],[-9.53175,52.03747],[-9.53168,52.03749],[-9.53155,52.03756],[-9.53154,52.03759],[-9.5315,52.03764],[-9.53147,52.03768],[-9.53142,52.03775],[-9.53134,52.03789],[-9.53132,52.03792],[-9.53128,52.03804],[-9.53126,52.0381],[-9.53123,52.03817],[-9.53122,52.03827],[-9.53122,52.03828],[-9.53124,52.03839],[-9.53123,52.03845],[-9.53121,52.03852],[-9.53116,52.03861],[-9.53115,52.03863],[-9.5311,52.03876],[-9.5311,52.0388],[-9.53107,52.03893],[-9.53107,52.03898],[-9.53107,52.039],[-9.53108,52.03911],[-9.53107,52.03916],[-9.53107,52.03921],[-9.531,52.03932],[-9.53099,52.03933],[-9.53092,52.03939],[-9.53083,52.03945],[-9.5308,52.03946],[-9.53064,52.03956],[-9.5306,52.0396],[-9.53054,52.03965],[-9.53047,52.03972],[-9.53045,52.03975],[-9.53045,52.03976],[-9.53043,52.03985],[-9.53043,52.03993],[-9.53043,52.03994],[-9.53044,52.04001],[-9.53046,52.04011],[-9.53047,52.04016],[-9.53065,52.04086],[-9.5307,52.04107],[-9.53071,52.04112],[-9.53072,52.04127]] } };

// 6. Tour Stops Data
const pointsGeoJSON = { 
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.530741,52.0416674,0]},"properties":{"name":"1. Start - Welcome to Ross Castle"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5315803,52.0414986,0]},"properties":{"name":"2. Walking Around the Castle"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5308018,52.0395105,0]},"properties":{"name":"3. Path toward Governor's Rock"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5348277,52.0369763,0]},"properties":{"name":"4. Smugglers on Lough Leane"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5443074,52.0380551,0]},"properties":{"name":"5. Governor's Rock Viewpoint"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5416467,52.0371311,0]},"properties":{"name":"6. Path to Copper Mines"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5367876,52.0352536,0]},"properties":{"name":"7. Ross Island Copper Mines"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5352874,52.036781,0]},"properties":{"name":"8. Trivia"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.5306416,52.0407941,0]},"properties":{"name":"9. Return to Ross Castle"}}
  ]
};

// ============================================================================
// END CONFIGURATION
// ============================================================================

// --- Initialize Player ---
document.getElementById('soundcloud-player').src = SC_SRC;

// --- Initialize Map ---
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/outdoors-v12', 
  center: START_CENTER,
  zoom: START_ZOOM,
  pitch: 60,
  bearing: -100,
  antialias: true
});

map.addControl(new mapboxgl.NavigationControl(), 'top-right');
map.addControl(new mapboxgl.GeolocateControl({
  positionOptions: { enableHighAccuracy: true },
  trackUserLocation: true,
  showUserHeading: true
}), 'top-right');

// --- Sidebar Logic ---
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleSidebar');
const closeBtnInner = document.getElementById('closeSidebarInner');

function initSidebarState() {
  if (window.innerWidth > 768) { sidebar.classList.remove('closed'); } 
  else { sidebar.classList.add('closed'); }
}
initSidebarState();

toggleBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  sidebar.classList.toggle('closed');
  sidebar.classList.toggle('active');
});

closeBtnInner.addEventListener('click', () => {
  sidebar.classList.add('closed');
  sidebar.classList.remove('active');
});

map.on('click', () => {
  if (window.innerWidth <= 768 && !sidebar.classList.contains('closed')) {
    sidebar.classList.add('closed');
    sidebar.classList.remove('active');
  }
});

// --- Audio Logic ---
const iframeElement = document.getElementById('soundcloud-player');
const widget = SC.Widget(iframeElement);
let markerObjects = [];

function showAudioConfirm(callback) {
  const modal = document.getElementById('audioModal');
  const yesBtn = document.getElementById('modal-yes');
  const noBtn = document.getElementById('modal-no');
  modal.style.display = 'flex'; 
  
  const newYes = yesBtn.cloneNode(true);
  const newNo = noBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(newYes, yesBtn);
  noBtn.parentNode.replaceChild(newNo, noBtn);

  newYes.onclick = () => { modal.style.display='none'; callback(true); };
  newNo.onclick = () => { modal.style.display='none'; callback(false); };
}

function addMarkers() {
  pointsGeoJSON.features.forEach((point, index) => {
    const popup = new mapboxgl.Popup({ offset: 25 }).setText(point.properties.name);
    const el = document.createElement('div');
    el.className = 'marker'; 
    if(index === 0) {
      el.textContent = 'Start';
      el.classList.add('marker-start');
    } else if(index === pointsGeoJSON.features.length - 1) {
      el.textContent = 'End';
      el.classList.add('marker-end');
    } else {
      el.textContent = index + 1;
      el.classList.add('marker-node');
    }
    const marker = new mapboxgl.Marker(el)
      .setLngLat(point.geometry.coordinates)
      .setPopup(popup)
      .addTo(map);
    markerObjects.push(marker);
  });
}

function populateSidebar() {
  const list = document.getElementById('stops');
  list.innerHTML = '';
  pointsGeoJSON.features.forEach((point, index) => {
    const li = document.createElement('li');
    li.textContent = point.properties.name;
    li.addEventListener('click', () => {
      if(window.innerWidth <= 768) {
        sidebar.classList.add('closed');
        sidebar.classList.remove('active');
      }
      const timestamp = audioTimestamps[index];
      map.flyTo({ center: point.geometry.coordinates, zoom: 16, pitch: 60 });
      showAudioConfirm((playFromHere) => {
        if (playFromHere && timestamp !== undefined) {
          widget.seekTo(timestamp);
          widget.play();
        }
      });
    });
    list.appendChild(li);
  });
}

function addRoute() {
  if (map.getSource('route')) return;
  map.addSource('route', { type: 'geojson', data: routeGeoJSON });
  map.addLayer({
    id: 'route-line',
    type: 'line',
    source: 'route',
    layout: { 'line-join': 'round', 'line-cap': 'round' },
    paint: { 'line-color': '#ff4d4d', 'line-width': 5, 'line-opacity': 0.8 }
  });
}

map.on('load', () => {
  addMarkers();
  populateSidebar();
  addRoute();
});

document.getElementById('styleDropdown').addEventListener('change', function(){
  const c = map.getCenter(), z = map.getZoom(), p = map.getPitch(), b = map.getBearing();
  map.setStyle(this.value);
  map.once('styledata', ()=>{
    map.jumpTo({center:c, zoom:z, pitch:p, bearing:b});
    addMarkers();
    addRoute();
  });
});

/* --- Guided Tour Logic --- */
const tourSteps = [
  { message: "ðŸ“ Enable your live location to see yourself on the map.", selector: '.mapboxgl-ctrl-geolocate' },
  { message: "ðŸŽ§ Use the Route List menu to jump to specific stops.", selector: '#toggleSidebar' },
  { message: "ðŸ—ºï¸ Switch between map styles using this dropdown.", selector: '#styleDropdown' }
];

let tourIndex = 0;
const tourOverlay = document.getElementById('tourOverlay');
const tourMessage = document.getElementById('tourMessage');
const tourNext = document.getElementById('tourNext');
const tourSkip = document.getElementById('tourSkip');

function showTourStep(index) {
  document.querySelectorAll('.highlight-active').forEach(el => el.classList.remove('highlight-active'));
  if (index >= tourSteps.length) {
    tourOverlay.style.display = 'none';
    return;
  }
  tourMessage.innerHTML = tourSteps[index].message;
  tourOverlay.style.display = 'block';
  tourNext.textContent = (index === tourSteps.length - 1) ? 'Finish' : 'Next';
  const selector = tourSteps[index].selector;
  if (selector) {
    const target = document.querySelector(selector);
    if (target) target.classList.add('highlight-active');
  }
}

tourNext.addEventListener('click', () => {
  tourIndex++;
  showTourStep(tourIndex);
});

tourSkip.addEventListener('click', () => {
  document.querySelectorAll('.highlight-active').forEach(el => el.classList.remove('highlight-active'));
  tourOverlay.style.display = 'none';
});

window.addEventListener('load', () => {
  tourIndex = 0;
  setTimeout(() => showTourStep(tourIndex), 1500);
});
</script>
</body>
</html>