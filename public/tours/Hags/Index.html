<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hag's Glen Audio Tour</title> 
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* --- DESIGN SYSTEM (Standardized) --- */
  :root {
    --primary: #8fa87a;
    --primary-light: #b7cba9;
    --dark: #2c3e50;
    --light: #ffffff;
    --gray: #f5f7fa;
    --shadow: 0 8px 30px rgba(0,0,0,0.12);
    --radius: 12px;
    --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --highlight-color: #ff3333; 
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body { 
    margin: 0; padding: 0; 
    font-family: 'Inter', sans-serif; 
    display: flex; height: 100vh; height: 100dvh; 
    overflow: hidden; color: var(--dark); background: var(--gray); 
  }

  /* --- Map & Layout --- */
  #map-container { flex: 1; position: relative; display: flex; flex-direction: column; height: 100%; width: 100%; }
  #map { width: 100%; height: 100%; flex: 1; outline: none; }

  /* --- Sidebar --- */
  #sidebar { 
    position: absolute; top: 20px; left: 20px; width: 280px; max-height: calc(100vh - 180px); 
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-radius: var(--radius); padding: 0; box-shadow: var(--shadow); z-index: 100; 
    display: flex; flex-direction: column; transform: translateX(0); transition: transform var(--transition); 
    overflow: hidden; border: 1px solid rgba(255,255,255,0.4); 
  }
  #sidebar.closed { transform: translateX(-150%); }

  .sidebar-header { padding: 16px 20px; background: var(--primary-light); color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .sidebar-title-group h2 { font-size: 16px; margin: 0; font-weight: 700; color: var(--dark); }
  .sidebar-subtitle { font-size: 11px; opacity: 0.8; color: var(--dark); margin-top: 2px; text-transform: uppercase; font-weight: 600; }
  
  #closeSidebarInner { background: rgba(255,255,255,0.3); border: none; color: var(--dark); width: 32px; height: 32px; border-radius: 50%; font-size: 20px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
  #closeSidebarInner:hover { background: rgba(255,255,255,0.6); }

  #stops { list-style: none; padding: 0; margin: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  #stops li { padding: 16px 20px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 14px; font-weight: 500; transition: background 0.2s; display: flex; align-items: center; }
  #stops li:hover { background: #f0f4ec; color: var(--primary); }
  #stops li::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--primary-light); border-radius: 50%; margin-right: 12px; flex-shrink: 0; }

  /* --- Player --- */
  #persistent-player { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 420px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.15); z-index: 50; padding: 12px; border: 1px solid rgba(255,255,255,0.6); transition: bottom 0.3s ease; }
  #soundcloud-player { width: 100%; height: 120px; border: none; border-radius: 8px; display: block; background: #f5f5f5; }
  .player-attribution { font-size: 11px; color: #888; text-align: center; margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .player-attribution a { color: var(--primary); text-decoration: none; font-weight: 600; }
  .mobile-handle { display: none; }

  /* --- Controls & Buttons --- */
  .control-pill { position: absolute; top: 20px; z-index: 40; background: var(--dark); color: white; border: none; border-radius: 30px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; transition: transform 0.1s, background 0.2s; }
  .control-pill:active { transform: scale(0.98); }
  #toggleSidebar { left: 20px; padding: 10px 16px; gap: 8px; }
  body:not(.sidebar-closed) #toggleSidebar { display: none; }

  .select-wrapper { position: absolute; top: 20px; right: 20px; z-index: 40; }
  #styleDropdown { appearance: none; -webkit-appearance: none; background-color: var(--dark); color: white; border: none; border-radius: 30px; padding: 10px 36px 10px 20px; font-size: 13px; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto; }
  .mapboxgl-ctrl-top-right { top: 65px !important; right: 20px !important; }

  /* --- Pulse Animation --- */
  @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.9); } 70% { box-shadow: 0 0 0 25px rgba(255, 51, 51, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); } }
  .highlight-active { animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; position: relative; z-index: 9999 !important; transition: all 0.3s; transform: scale(1.05); border: 2px solid var(--highlight-color) !important; }
  .mapboxgl-ctrl-geolocate.highlight-active { border-radius: 50% !important; }
  #toggleSidebar.highlight-active { position: absolute; }

  /* --- Markers --- */
  .marker { background-size: cover; background-color: var(--primary-light); border: 2px solid white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s, background 0.2s; display: flex; align-items: center; justify-content: center; font-weight: 700; }
  .marker:hover { transform: scale(1.15); z-index: 50; border-color: var(--dark); }
  .marker-node { width: 28px; height: 28px; border-radius: 50%; color: white; font-size: 12px; }
  .marker-start { width: 50px; height: 50px; background-color: var(--dark); color: white; border-radius: 50%; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border: 3px solid white; }
  .marker-end { width: 40px; height: 40px; background-color: #e74c3c; color: white; border-radius: 50%; font-size: 10px; font-weight: 700; border: 3px solid white; }

  /* --- Modals & Tour Overlay --- */
  .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); align-items: center; justify-content: center; opacity: 0; animation: fadeIn 0.3s forwards; }
  .modal-content { background: white; padding: 24px 32px; border-radius: 16px; max-width: 320px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); transform: scale(0.9); animation: popIn 0.3s forwards; }
  .modal-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
  .btn { padding: 10px 24px; border: none; border-radius: 30px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: var(--dark); color: white; }
  .btn-secondary { background: #e0e0e0; color: #333; }

  #tourOverlay { position: fixed; bottom: 220px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.95); color: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 340px; text-align: center; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; backdrop-filter: blur(8px); animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  #tourMessage { font-size: 14px; line-height: 1.5; margin-bottom: 15px; }
  .tour-actions { display: flex; justify-content: space-between; align-items: center; }
  .btn-tour { padding: 6px 14px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
  #tourNext { background: var(--primary-light); color: var(--dark); }
  #tourSkip { background: transparent; color: #aaa; }

  @keyframes fadeIn { to { opacity: 1; } }
  @keyframes popIn { to { transform: scale(1); } }
  @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

  /* --- Responsive --- */
  @media (max-width: 768px) {
    .mapboxgl-ctrl-top-right { top: 70px !important; }
    #toggleSidebar { display: flex !important; top: 15px; left: 15px; }
    .select-wrapper { top: 15px; right: 15px; }
    #sidebar { top: 0; left: 0; height: 100dvh; max-height: 100dvh; width: 100%; border-radius: 0; border: none; transform: translateX(-100%); z-index: 2000; }
    #sidebar.active { transform: translateX(0); }
    #sidebar.closed { transform: translateX(-100%); }
    #persistent-player { bottom: 0; left: 0; width: 100%; max-width: 100%; transform: none; border-radius: 24px 24px 0 0; padding: 12px 12px 0 12px; padding-bottom: calc(env(safe-area-inset-bottom) + 15px); background: white; }
    #soundcloud-player { height: 110px; }
    .mobile-handle { display: block; width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 10px auto; }
    #tourOverlay { bottom: 180px; }
  }
</style>
</head>
<body>

<button id="toggleSidebar" class="control-pill">
  <span>â˜°</span> Route List
</button>

<div id="sidebar" class="closed"> 
  <div class="sidebar-header">
    <div class="sidebar-title-group">
      <h2>Hag's Glen</h2>
      <div class="sidebar-subtitle">Audio Guided Tour</div>
    </div>
    <button id="closeSidebarInner" aria-label="Close Menu">&times;</button>
  </div>
  <ul id="stops"></ul>
</div>

<div id="map-container">
  <div class="select-wrapper">
    <select id="styleDropdown">
      <option value="mapbox://styles/mapbox/outdoors-v12" selected>Outdoors</option>
      <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
      <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite</option>
      <option value="mapbox://styles/mapbox/light-v11">Light</option>
      <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
    </select>
  </div>
  
  <div id="map"></div>

  <div id="persistent-player">
    <div class="mobile-handle"></div>
    <iframe id="soundcloud-player" scrolling="no" frameborder="no" allow="autoplay" src=""></iframe>
    <div class="player-attribution">
      <a href="https://soundcloud.com/killarneyaudiotours/hags-glen/s-C5RHhImSKg3" target="_blank">Hags Glen Audio</a>
    </div>
  </div>
</div>

<div id="audioModal" class="modal">
  <div class="modal-content">
    <p id="modal-text">Jump audio to this location?</p>
    <div class="modal-buttons">
      <button id="modal-yes" class="btn btn-primary">Yes, Play</button>
      <button id="modal-no" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<div id="tourOverlay">
  <div id="tourMessage"></div>
  <div class="tour-actions">
    <button id="tourSkip" class="btn-tour">Dismiss</button>
    <button id="tourNext" class="btn-tour">Next Step</button>
  </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://w.soundcloud.com/player/api.js"></script>

<script>
// ============================================================================
// SECTION B: TOUR CONFIGURATION (UPDATED FOR HAG'S GLEN)
// ============================================================================

// 1. Map Start Position
const START_CENTER = [-9.6999077, 52.02147]; 
const START_ZOOM = 14;

// 2. SoundCloud Source URL
const SC_SRC = "https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/soundcloud%3Atracks%3A2242158086%3Fsecret_token%3Ds-C5RHhImSKg3&color=%238fa87a&auto_play=false&hide_related=false&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=false";

// 3. Audio Timestamps
const audioTimestamps = [0, 211000, 382000, 1135000, 1524000];

// 4. Mapbox Token
mapboxgl.accessToken = 'pk.eyJ1IjoiZW9naGFub2QiLCJhIjoiY21lOXFwOGhyMHVvNTJrcXZnY3I1dGlnOSJ9.7g8Xb_w6p8QiMNloqwPVRQ';

// 5. Route Line Data
const routeGeoJSON = { "type":"FeatureCollection", "features": [
{"type":"Feature","geometry":{"type":"LineString","coordinates":[[-9.69583,52.0265],[-9.69589,52.02649],[-9.69599,52.02644],[-9.69605,52.02639],[-9.69609,52.02633],[-9.69616,52.02627],[-9.69618,52.02626],[-9.69624,52.02625],[-9.69634,52.02622],[-9.69642,52.02617],[-9.6965,52.02614],[-9.6966,52.02613],[-9.69667,52.02613],[-9.6967,52.02612],[-9.69676,52.02611],[-9.69681,52.02606],[-9.69683,52.02598],[-9.69687,52.0259],[-9.69691,52.02581],[-9.69692,52.02578],[-9.69695,52.02574],[-9.697,52.0257],[-9.69761,52.02523],[-9.69779,52.02509],[-9.69797,52.02495],[-9.69809,52.02486],[-9.69817,52.02481],[-9.69823,52.02482],[-9.69832,52.02483],[-9.69838,52.02483],[-9.69842,52.02481],[-9.69856,52.02474],[-9.69864,52.02468],[-9.69875,52.0246],[-9.6988,52.02455],[-9.69879,52.02453],[-9.69878,52.0245],[-9.6987,52.02439],[-9.6987,52.02436],[-9.69869,52.02436],[-9.69872,52.02432],[-9.69883,52.0242],[-9.69894,52.02409],[-9.69897,52.02405],[-9.69905,52.02394],[-9.69908,52.02389],[-9.69909,52.02388],[-9.69913,52.02385],[-9.69918,52.02381],[-9.69952,52.02354],[-9.69978,52.02334],[-9.69983,52.02327],[-9.69998,52.02316],[-9.70013,52.02302],[-9.7002,52.02296],[-9.70028,52.02289],[-9.70031,52.02287],[-9.70041,52.02281],[-9.7005,52.02274],[-9.70067,52.02259],[-9.70101,52.0223],[-9.70119,52.02216],[-9.70137,52.022],[-9.70172,52.02172],[-9.70189,52.02158],[-9.70191,52.02156],[-9.70198,52.02151],[-9.70205,52.02148],[-9.70212,52.02145],[-9.70228,52.02135],[-9.70277,52.02087],[-9.70282,52.02083],[-9.70296,52.0207],[-9.70311,52.02058],[-9.7032,52.0205],[-9.70328,52.02044],[-9.70337,52.02037],[-9.70343,52.02032],[-9.70353,52.02023],[-9.7038,52.02006],[-9.70385,52.02003],[-9.70386,52.02002],[-9.70389,52.01998],[-9.70392,52.01994],[-9.70394,52.0199],[-9.70397,52.01987],[-9.70401,52.01983],[-9.70416,52.01973],[-9.7043,52.01963],[-9.70436,52.01957],[-9.7044,52.01952],[-9.70444,52.01947],[-9.70448,52.01944],[-9.70449,52.01944],[-9.7046,52.0194],[-9.7047,52.01935],[-9.70473,52.01933],[-9.7048,52.01929],[-9.7049,52.01923],[-9.70494,52.01922],[-9.70496,52.01921],[-9.70504,52.01919],[-9.70511,52.01917],[-9.70517,52.01912],[-9.70525,52.01909],[-9.7054,52.01907],[-9.70546,52.01907],[-9.70565,52.01904],[-9.70582,52.01902],[-9.70591,52.019],[-9.70596,52.01898],[-9.706,52.01894],[-9.70607,52.01889],[-9.70638,52.01868],[-9.70648,52.01861],[-9.70657,52.01858],[-9.70668,52.01856],[-9.70687,52.01856],[-9.7069,52.01856],[-9.707,52.01858],[-9.7071,52.01864],[-9.70715,52.01865],[-9.70722,52.01869],[-9.70736,52.01874],[-9.7074,52.01874],[-9.70748,52.01876],[-9.70764,52.01876],[-9.70769,52.01875],[-9.7078,52.01873],[-9.70804,52.01865],[-9.70825,52.0186],[-9.7084,52.01852],[-9.70855,52.01843],[-9.70866,52.01837],[-9.70879,52.01831],[-9.70889,52.01826],[-9.70902,52.01819],[-9.7092,52.01811],[-9.70928,52.01811],[-9.70943,52.01794],[-9.70952,52.01783],[-9.70989,52.01749],[-9.70994,52.01745],[-9.71006,52.01735],[-9.71013,52.01728],[-9.71024,52.01721],[-9.71034,52.01714],[-9.71044,52.01708],[-9.71051,52.01703],[-9.71077,52.01678],[-9.71133,52.01622],[-9.71152,52.01604],[-9.7117,52.01591],[-9.71173,52.01588],[-9.71189,52.01573],[-9.71204,52.01557],[-9.71209,52.01553],[-9.71234,52.01527],[-9.71249,52.01511],[-9.71257,52.01503],[-9.71265,52.01496],[-9.71281,52.01482],[-9.71304,52.01463],[-9.71315,52.01452],[-9.71345,52.01421],[-9.71351,52.01415],[-9.71374,52.0139],[-9.71388,52.01374],[-9.71392,52.01369],[-9.714,52.01357],[-9.71407,52.01347],[-9.71408,52.0133],[-9.71407,52.01322],[-9.71407,52.01317],[-9.71411,52.01305],[-9.71423,52.01292],[-9.71426,52.01289],[-9.7144,52.01273],[-9.71442,52.01271],[-9.71457,52.01259],[-9.71462,52.01255],[-9.71474,52.01244],[-9.71495,52.01228],[-9.71505,52.01221],[-9.7151,52.01216],[-9.71518,52.01209],[-9.71525,52.012],[-9.71533,52.01191],[-9.7154,52.01185],[-9.71542,52.01183],[-9.7155,52.01168],[-9.71554,52.01161],[-9.71562,52.01152],[-9.71565,52.01148],[-9.71573,52.01139],[-9.71577,52.01136],[-9.71589,52.01129],[-9.7161,52.0112],[-9.71615,52.01111],[-9.7162,52.01103],[-9.71636,52.01077],[-9.71647,52.0106],[-9.71651,52.01052],[-9.71657,52.01043],[-9.71673,52.0102],[-9.7168,52.0101],[-9.71686,52.01001],[-9.71695,52.00986],[-9.71705,52.00978],[-9.71714,52.00973],[-9.71723,52.00964],[-9.71726,52.00961],[-9.7173,52.00947],[-9.71728,52.00931],[-9.71738,52.0092],[-9.71761,52.00887],[-9.71764,52.00883],[-9.71775,52.00862],[-9.71776,52.00853],[-9.71778,52.00848],[-9.71778,52.00846],[-9.71777,52.00843],[-9.71773,52.0084],[-9.71768,52.00838],[-9.71766,52.00837],[-9.71762,52.00835],[-9.7176,52.00834],[-9.71759,52.00831],[-9.71759,52.00829],[-9.7176,52.00824],[-9.7176,52.00822],[-9.71763,52.00807],[-9.71763,52.00804],[-9.71766,52.00784],[-9.71783,52.00697],[-9.71787,52.00679],[-9.71797,52.00627],[-9.71797,52.00626],[-9.71797,52.00615],[-9.71802,52.00608],[-9.71804,52.00605],[-9.71815,52.006],[-9.71822,52.00596],[-9.7183,52.0059],[-9.7184,52.00581],[-9.71841,52.00581],[-9.71847,52.00574],[-9.71858,52.00568],[-9.71876,52.00561],[-9.71882,52.00557],[-9.71888,52.00554],[-9.71902,52.00544],[-9.71916,52.00537],[-9.71927,52.00528],[-9.71935,52.0052],[-9.7195,52.00516],[-9.71994,52.00508],[-9.71996,52.00507],[-9.72022,52.00499],[-9.72049,52.00492],[-9.72069,52.00487],[-9.72098,52.00473],[-9.72106,52.0047],[-9.72122,52.00463],[-9.72151,52.0045],[-9.72164,52.0044],[-9.72166,52.00439],[-9.72185,52.00434],[-9.72217,52.00422],[-9.72235,52.00416],[-9.72242,52.00413],[-9.72251,52.00409],[-9.72266,52.00404],[-9.72267,52.00403],[-9.72283,52.00396],[-9.72289,52.00392],[-9.72295,52.00386],[-9.72306,52.00377],[-9.7231,52.00375],[-9.72321,52.00363],[-9.72333,52.00354],[-9.72341,52.00348],[-9.72349,52.00342],[-9.72358,52.00334],[-9.72366,52.00327],[-9.72375,52.00319],[-9.72384,52.00312],[-9.72391,52.00304],[-9.72395,52.003],[-9.72405,52.0029],[-9.72411,52.00279],[-9.72418,52.00264],[-9.72422,52.00254],[-9.72422,52.00252],[-9.72428,52.00244],[-9.72434,52.00234],[-9.72443,52.00222],[-9.72444,52.00221],[-9.72456,52.00205],[-9.72468,52.00188],[-9.72478,52.00176],[-9.72481,52.00172],[-9.72496,52.00156],[-9.72505,52.00147],[-9.72523,52.00125],[-9.72536,52.00109],[-9.72547,52.00095],[-9.7255,52.00093],[-9.72563,52.00077],[-9.72579,52.00059],[-9.72616,52.00021],[-9.72622,52.00014],[-9.72635,51.99998],[-9.7264,51.99993],[-9.72658,51.99965],[-9.72667,51.99951],[-9.72684,51.99932],[-9.72695,51.99919],[-9.72701,51.99913],[-9.72712,51.99904],[-9.72717,51.99901],[-9.72727,51.99894],[-9.72741,51.9988],[-9.72748,51.99876],[-9.72764,51.99869],[-9.72773,51.99857],[-9.72778,51.99847],[-9.72779,51.99844],[-9.72799,51.99835],[-9.72801,51.99834],[-9.72814,51.99828],[-9.72822,51.99824],[-9.7283,51.9982],[-9.72846,51.99816],[-9.72847,51.99816],[-9.72867,51.99812],[-9.7287,51.99807],[-9.72877,51.99798],[-9.72885,51.99792],[-9.7289,51.99789],[-9.72911,51.99784],[-9.72914,51.99784],[-9.72939,51.9978],[-9.72941,51.9978],[-9.7296,51.99773],[-9.72964,51.99771],[-9.72989,51.99763],[-9.7299,51.99763],[-9.72995,51.99749],[-9.7299,51.99747],[-9.72979,51.99742],[-9.72979,51.99726]]},"properties":{"name":"Route","styleUrl":"#line-1267FF-5000-nodesc","stroke-opacity":1,"stroke":"#1267ff","stroke-width":5}}
]};

// 6. Tour Stops Data
const pointsGeoJSON = { 
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.6958077,52.0264921,0]},"properties":{"name":"1. Cronin's Yard - Departing"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.7038789,52.0199873,0]},"properties":{"name":"2. River and the Glen"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.7129023,52.0146474,0]},"properties":{"name":"3. Meeting the Mountains"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.7177566,52.0069814,0]},"properties":{"name":"4. Myth and Lakes"}},
    {"type":"Feature","geometry":{"type":"Point","coordinates":[-9.7297729,51.9972588,0]},"properties":{"name":"5. Devils Ladder"}}
  ]
};

// ============================================================================
// END CONFIGURATION
// ============================================================================

// --- Initialize Player ---
document.getElementById('soundcloud-player').src = SC_SRC;

// --- Initialize Map ---
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/outdoors-v12', // Specific style for outdoor hiking
  center: START_CENTER,
  zoom: START_ZOOM,
  pitch: 60,
  bearing: -100,
  antialias: true
});

map.addControl(new mapboxgl.NavigationControl(), 'top-right');
map.addControl(new mapboxgl.GeolocateControl({
  positionOptions: { enableHighAccuracy: true },
  trackUserLocation: true,
  showUserHeading: true
}), 'top-right');

// --- Sidebar Logic ---
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleSidebar');
const closeBtnInner = document.getElementById('closeSidebarInner');

function initSidebarState() {
  if (window.innerWidth > 768) { sidebar.classList.remove('closed'); } 
  else { sidebar.classList.add('closed'); }
}
initSidebarState();

toggleBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  sidebar.classList.toggle('closed');
  sidebar.classList.toggle('active');
});

closeBtnInner.addEventListener('click', () => {
  sidebar.classList.add('closed');
  sidebar.classList.remove('active');
});

map.on('click', () => {
  if (window.innerWidth <= 768 && !sidebar.classList.contains('closed')) {
    sidebar.classList.add('closed');
    sidebar.classList.remove('active');
  }
});

// --- Audio Logic ---
const iframeElement = document.getElementById('soundcloud-player');
const widget = SC.Widget(iframeElement);
let markerObjects = [];

function showAudioConfirm(callback) {
  const modal = document.getElementById('audioModal');
  const yesBtn = document.getElementById('modal-yes');
  const noBtn = document.getElementById('modal-no');
  modal.style.display = 'flex'; 
  
  const newYes = yesBtn.cloneNode(true);
  const newNo = noBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(newYes, yesBtn);
  noBtn.parentNode.replaceChild(newNo, noBtn);

  newYes.onclick = () => { modal.style.display='none'; callback(true); };
  newNo.onclick = () => { modal.style.display='none'; callback(false); };
}

function addMarkers() {
  pointsGeoJSON.features.forEach((point, index) => {
    const popup = new mapboxgl.Popup({ offset: 25 }).setText(point.properties.name);
    const el = document.createElement('div');
    el.className = 'marker'; 
    if(index === 0) {
      el.textContent = 'Start';
      el.classList.add('marker-start');
    } else if(index === pointsGeoJSON.features.length - 1) {
      el.textContent = 'End';
      el.classList.add('marker-end');
    } else {
      el.textContent = index + 1;
      el.classList.add('marker-node');
    }
    const marker = new mapboxgl.Marker(el)
      .setLngLat(point.geometry.coordinates)
      .setPopup(popup)
      .addTo(map);
    markerObjects.push(marker);
  });
}

function populateSidebar() {
  const list = document.getElementById('stops');
  list.innerHTML = '';
  pointsGeoJSON.features.forEach((point, index) => {
    const li = document.createElement('li');
    li.textContent = point.properties.name;
    li.addEventListener('click', () => {
      if(window.innerWidth <= 768) {
        sidebar.classList.add('closed');
        sidebar.classList.remove('active');
      }
      const timestamp = audioTimestamps[index];
      map.flyTo({ center: point.geometry.coordinates, zoom: 16, pitch: 60 });
      showAudioConfirm((playFromHere) => {
        if (playFromHere) {
          widget.seekTo(timestamp);
          widget.play();
        }
      });
    });
    list.appendChild(li);
  });
}

function addRoute() {
  if (map.getSource('route')) return;
  map.addSource('route', { type: 'geojson', data: routeGeoJSON });
  map.addLayer({
    id: 'route-line',
    type: 'line',
    source: 'route',
    layout: { 'line-join': 'round', 'line-cap': 'round' },
    paint: { 'line-color': '#ff4d4d', 'line-width': 5, 'line-opacity': 0.8 }
  });
}

map.on('load', () => {
  addMarkers();
  populateSidebar();
  addRoute();
});

document.getElementById('styleDropdown').addEventListener('change', function(){
  const c = map.getCenter(), z = map.getZoom(), p = map.getPitch(), b = map.getBearing();
  map.setStyle(this.value);
  map.once('styledata', ()=>{
    map.jumpTo({center:c, zoom:z, pitch:p, bearing:b});
    addMarkers();
    addRoute();
  });
});

/* --- Guided Tour Logic --- */
const tourSteps = [
  { message: "ðŸ“ Enable your live location to see yourself on the map.", selector: '.mapboxgl-ctrl-geolocate' },
  { message: "ðŸŽ§ Use the Route List menu to jump to specific stops.", selector: '#toggleSidebar' },
  { message: "ðŸ—ºï¸ Switch between map styles using this dropdown.", selector: '#styleDropdown' }
];

let tourIndex = 0;
const tourOverlay = document.getElementById('tourOverlay');
const tourMessage = document.getElementById('tourMessage');
const tourNext = document.getElementById('tourNext');
const tourSkip = document.getElementById('tourSkip');

function showTourStep(index) {
  document.querySelectorAll('.highlight-active').forEach(el => el.classList.remove('highlight-active'));
  if (index >= tourSteps.length) {
    tourOverlay.style.display = 'none';
    return;
  }
  tourMessage.innerHTML = tourSteps[index].message;
  tourOverlay.style.display = 'block';
  tourNext.textContent = (index === tourSteps.length - 1) ? 'Finish' : 'Next';
  const selector = tourSteps[index].selector;
  if (selector) {
    const target = document.querySelector(selector);
    if (target) target.classList.add('highlight-active');
  }
}

tourNext.addEventListener('click', () => {
  tourIndex++;
  showTourStep(tourIndex);
});

tourSkip.addEventListener('click', () => {
  document.querySelectorAll('.highlight-active').forEach(el => el.classList.remove('highlight-active'));
  tourOverlay.style.display = 'none';
});

window.addEventListener('load', () => {
  tourIndex = 0;
  setTimeout(() => showTourStep(tourIndex), 1500);
});
</script>
</body>
</html>